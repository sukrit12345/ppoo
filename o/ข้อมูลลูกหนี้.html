

//คำนวณหน้าคืนเงิน
app.get('/api/calculate_interest_profit/:refund_id', async (req, res) => {
    try {
        const refundId = req.params.refund_id;

        // ค้นหาข้อมูล refund จาก ID ที่ให้มา
        const refund = await Refund.findById(refundId);

        if (!refund) {
            return res.status(404).send('Refund not found');
        }

        // ค้นหาข้อมูล loan ที่ตรงกับ id_card_number, contract_number, และ bill_number
        const loan = await LoanInformation.findOne({
            id_card_number: refund.id_card_number,
            contract_number: refund.contract_number,
            bill_number: refund.bill_number
        });

        if (!loan) {
            return res.status(404).send('Loan not found');
        }

        // คำนวณข้อมูลเพิ่มเติมของสัญญา
        const currentDate = new Date();
        const calculatedLoanData = calculateLoanData(loan, currentDate);

        // ดึงค่า totalInterest4 และ principal จากข้อมูลที่คำนวณ
        const totalInterest4 = calculatedLoanData.totalInterest4;
        const principal = loan.principal;

        // คำนวณ totalInterest5 โดยลบค่า refund_interest ออกจาก totalInterest4
        let totalInterest5 = totalInterest4 - refund.refund_interest;

        // ตรวจสอบว่า totalInterest5 เป็นค่าลบหรือศูนย์
        if (totalInterest5 <= 0) {
         totalInterest5 = 0;
        }

        // ค้นหา loan ที่ตรงกับ id_card_number, contract_number และ bill_number = 1
        const initialLoan = await LoanInformation.findOne({
            id_card_number: refund.id_card_number,
            contract_number: refund.contract_number,
            bill_number: '1'
        });

        if (!initialLoan) {
            return res.status(404).send('Initial Loan not found');
        }

        // ค้นหา refunds ทั้งหมดที่มี id_card_number และ contract_number ตรงกัน และ bill_number น้อยกว่าหรือเท่ากับ bill_number ปัจจุบัน
        const allRefunds = await Refund.find({
            id_card_number: refund.id_card_number,
            contract_number: refund.contract_number,
            bill_number: { $lte: refund.bill_number }
        });

        // รวบรวม total_refund ทั้งหมด
        const totalRefundSum = allRefunds.reduce((sum, r) => sum + parseFloat(r.total_refund), 0);

        // คำนวณ initial_profit โดยลบค่า principal ของ initialLoan ออกจาก totalRefundSum
        const initial_profit = totalRefundSum - initialLoan.principal;

        // ส่งข้อมูลที่คำนวณได้กลับเป็น JSON
        res.json({
            totalInterest5,
            initial_profit
        });
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: 'Internal server error' });
    }
});










//บันทึกคืนเงินเเละสัญญา
app.post('/refunds/submit_form', upload.fields([
    { name: 'refund_receipt_photo', maxCount: 1 }
]), async (req, res) => {
    try {
        const { id_card_number, contract_number, bill_number, manager, fname, lname, return_date, refund_principal, refund_interest, total_refund } = req.body;

        // ค้นหาข้อมูล loan ที่ตรงกับ id_card_number, contract_number, และ bill_number
        const loan = await LoanInformation.findOne({
            id_card_number,
            contract_number,
            bill_number
        });

        // ถ้าไม่พบ loan ที่ตรงกัน ให้ส่ง error
        if (!loan) {
            return res.status(400).send('Loan not found');
        }

        const refundData = {
            manager,
            id_card_number,
            fname,
            lname,
            contract_number,
            bill_number,
            principal: principal || '', // ตั้งค่าเป็นค่าว่างถ้า principal ไม่ได้ระบุ
            totalInterest4: totalInterest4 || '', // ตั้งค่าเป็นค่าว่างถ้า totalInterest4 ไม่ได้ระบุ
            totalReturned: totalReturned || '', // ตั้งค่าเป็นค่าว่างถ้า totalReturned ไม่ได้ระบุ
            return_date,
            refund_principal: refund_principal || 0, // ตั้งค่าเป็น 0 ถ้า refund_principal เป็นค่าว่าง
            refund_interest: refund_interest || 0, // ตั้งค่าเป็น 0 ถ้า refund_interest เป็นค่าว่าง
            debtAmount: debtAmount || 0, // ตั้งค่าเป็น 0 ถ้า debtAmount เป็นค่าว่าง
            total_refund,
            totalInterest5: totalInterest5 || '', // ตั้งค่าเป็นค่าว่างถ้า totalInterest5 ไม่ได้ระบุ
            initial_profit: initial_profit || '', // ตั้งค่าเป็นค่าว่างถ้า initial_profit ไม่ได้ระบุ
            refund_receipt_photo: req.files['refund_receipt_photo'] ? req.files['refund_receipt_photo'][0].path : '',
            loan: loan._id // อ้างอิงถึงไอดีของ loan
        };
        
        // บันทึกข้อมูลลงในฐานข้อมูล
        const newRefund = new Refund(refundData);
        await newRefund.save();

        // คำนวณ totalInterest5 โดยลบค่า refund_interest ออกจาก totalInterest4
        const calculatedLoanData = calculateLoanData(loan, new Date());
        const totalInterest4 = calculatedLoanData.totalInterest4;
        let totalInterest5 = totalInterest4 - refund_interest;
        if (totalInterest5 < 0) {
        totalInterest5 = 0;
        }

        // คำนวณ totalRefund เป็นผลรวมของ principal และ totalInterest4
        const totalRefund = parseFloat(loan.principal - (refund_principal || 0)) + parseFloat(totalInterest4);



        // ตรวจสอบว่าจำนวนเงินคืนตรงกับ totalRefund หรือไม่
        if (parseFloat(total_refund) === loan.totalRefund) {
            // ไม่ต้องสร้างสัญญาใหม่
            res.redirect(`/คืนเงิน.html?id_card_number=${id_card_number}&fname=${fname}&lname=${lname}&manager=${manager}`);
        } else {
            // สร้างข้อมูลสัญญาใหม่
            const newBillNumber = (parseInt(loan.bill_number) + 1).toString();
            const newLoanData = {
                manager: loan.manager,
                id_card_number: loan.id_card_number,
                fname: loan.fname,
                lname: loan.lname,
                contract_number: loan.contract_number,
                bill_number: newBillNumber,
                loanDate: return_date, // ให้วันที่เริ่มสัญญาเท่ากับวันที่คืนเงิน
                loanPeriod: loan.loanPeriod,
                returnDate: new Date(new Date(return_date).getTime() + loan.loanPeriod * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                principal: loan.principal - (refund_principal || 0), // ลบจำนวนเงินที่คืนออกจากเงินหลัก ถ้า refund_principal เป็นค่าว่างให้เท่ากับ 0
                interestRate: loan.interestRate,
                totalInterest: (loan.principal - (refund_principal || 0)) * loan.interestRate * loan.loanPeriod / 100, // คำนวณ totalInterest ใหม่
                totalInterest2: loan.totalInterest2,
                totalInterest3: totalInterest5,
                totalInterest4: totalInterest4,
                totalRefund: totalRefund,
                storeAssets: loan.storeAssets,
                icloudAssets: loan.icloudAssets,
                assetReceiptPhoto: loan.assetReceiptPhoto,
                icloudAssetPhoto: loan.icloudAssetPhoto,
                refundReceiptPhoto: loan.refundReceiptPhoto,
                contract: loan.contract,
                debtor: loan.debtor
            };

            // บันทึกข้อมูลสัญญาใหม่
            const newLoan = new LoanInformation(newLoanData);
            await newLoan.save();

            await DebtorInformation.updateOne(
                { _id: loan.debtor },
                { $push: { loans: newLoan._id } }
            );

            res.redirect(`/คืนเงิน.html?id_card_number=${id_card_number}&fname=${fname}&lname=${lname}&manager=${manager}`);
        }
    } catch (err) {
        console.error(err);
        res.status(500).redirect('/error.html'); // เปลี่ยนเส้นทางการ redirect ตามที่คุณต้องการ
    }
});


//คำนวณหน้าสัญญา
function calculateLoanData(loan, currentDate) {
    const returnDate = new Date(loan.returnDate);

    // คำนวณวันใกล้ถึงสัญญา
    let totalRepayment = Math.round((returnDate - currentDate) / (1000 * 60 * 60 * 24));
    if (totalRepayment <= 0) {
        totalRepayment = '-';
    }

    // คำนวณวันเลยสัญญา
    let daysUntilReturn = Math.round((currentDate - returnDate) / (1000 * 60 * 60 * 24));
    if (daysUntilReturn <= 0) {
        daysUntilReturn = '-';
    }

    // คำนวณดอกปรับ
    let totalInterest2 = daysUntilReturn !== '-' ? Math.round(daysUntilReturn * loan.interestRate * loan.principal / 100) : 0;

    // ถ้าค่า totalInterest2 หรือ totalInterest3 เป็น '-' หรือค่าว่างให้ตั้งค่าเป็น 0
    totalInterest2 = totalInterest2 === '-' || totalInterest2 === '' || totalInterest2 === 'undefined' ? 0 : totalInterest2;

    // คำนวณ Totalreturned โดยไม่รวมค่าที่เป็น '-'
    let totalReturned = Number(loan.principal) + Number(loan.totalInterest) + Number(totalInterest2) + (loan.totalInterest3 !== undefined && loan.totalInterest3 !== null ? Number(loan.totalInterest3) : 0);

    // คำนวณ totalInterest4
    let totalInterest4 = Number(loan.totalInterest) + Number(totalInterest2) + (loan.totalInterest3 !== undefined && loan.totalInterest3 !== null ? Number(loan.totalInterest3) : 0);

    return {
        ...loan._doc,
        totalRepayment,
        daysUntilReturn,
        totalInterest2,
        totalReturned,
        totalInterest4
    };
}















document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const idCardNumber = urlParams.get('id_card_number');

    // Fetch API เพื่อดึงข้อมูล LoanInformation ตาม id_card_number
    fetch(`/api/loan-data?id_card_number=${idCardNumber}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error fetching loan data');
            }
            return response.json();
        })
        .then(loans => {
            // เมื่อได้ข้อมูล loans มาแล้ว จะทำการดึงข้อมูล refunds ต่อ
            return fetch(`/api/refunds/${idCardNumber}`).then(response => {
                if (!response.ok) {
                    throw new Error('Error fetching refund data');
                }
                return response.json();
            }).then(refunds => {
                const table = document.getElementById('b');
                refunds.reverse().forEach(refund => {
                    // สร้างแถวใหม่
                    const tr = document.createElement('tr');

                    // ตรวจสอบว่ามีข้อมูลใน LoanInformation ที่ตรงกับ refunds หรือไม่
                    const matchedLoan = loans.find(loan => 
                        loan.id_card_number === refund.id_card_number && 
                        loan.contract_number === refund.contract_number && 
                        loan.bill_number === refund.bill_number
                    );

                    // กำหนดค่าให้กับ totalReturned จาก LoanInformation หากพบข้อมูลที่ตรงกัน
                    const totalReturned = matchedLoan ? matchedLoan.totalReturned : '-';
                    const principal = matchedLoan ? matchedLoan.principal : '-';
                    const totalInterest4 = matchedLoan ? matchedLoan.totalInterest4 : '-';

                    // คำนวณ totalInterest5 และ initial_profit โดยดึงจาก API
                    fetch(`/api/calculate_interest_profit/${refund._id}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error calculating interest and profit');
                            }
                            return response.json();
                        })
                        .then(calculatedValues => {
                            const { totalInterest5, initial_profit } = calculatedValues;

                            // เช็คเงื่อนไขว่า total_refund ไม่เท่ากับ totalReturned
                            if (totalReturned !== '-' && refund.total_refund < totalReturned) {
                                // บันทึกข้อมูลสัญญาใหม่อัตโนมัติ
                                const newLoanData = {
                                    manager: refund.manager,
                                    id_card_number: refund.id_card_number,
                                    fname: refund.fname,
                                    lname: refund.lname,
                                    contract_number: refund.contract_number,
                                    bill_number: (parseInt(refund.bill_number) + 1).toString(),
                                    loanDate: new Date().toISOString().split('T')[0], // วันที่ปัจจุบัน
                                    loanPeriod: matchedLoan.loanPeriod,
                                    returnDate: matchedLoan.returnDate,
                                    principal: matchedLoan.principal,
                                    interestRate: matchedLoan.interestRate,
                                    totalInterest: matchedLoan.principal * matchedLoan.interestRate, // คำนวณ totalInterest ใหม่
                                    totalInterest2: matchedLoan.totalInterest2 || 0,
                                    totalInterest3: totalInterest5,
                                    totalInterest4: matchedLoan.totalInterest4,
                                    totalRefund: matchedLoan.totalRefund,
                                    status: matchedLoan.status,
                                    storeAssets: matchedLoan.storeAssets,
                                    icloudAssets: matchedLoan.icloudAssets,
                                    assetReceiptPhoto: matchedLoan.assetReceiptPhoto,
                                    icloudAssetPhoto: matchedLoan.icloudAssetPhoto,
                                    refundReceiptPhoto: matchedLoan.refundReceiptPhoto,
                                    contract: matchedLoan.contract,
                                    debtor: matchedLoan.debtor
                                };

                                // เรียก API เพื่อบันทึกข้อมูลสัญญาใหม่
                                fetch('/api/add-loan', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(newLoanData)
                                }).then(response => {
                                    if (!response.ok) {
                                        throw new Error('Error saving new loan information');
                                    }
                                    return response.json();
                                }).then(data => {
                                    console.log('New loan information saved:', data);
                                }).catch(error => {
                                    console.error('Error saving new loan information:', error);
                                });
                            }

                            tr.innerHTML = `
                                <td>${refund.contract_number}</td>
                                <td>${refund.bill_number}</td>
                                <td>${principal}</td>
                                <td>${totalInterest4}</td>
                                <td>${totalReturned}</td>
                                <td>${refund.return_date}</td>
                                <td>${refund.refund_principal}</td>
                                <td>${refund.refund_interest}</td>
                                <td>-</td>
                                <td>${refund.total_refund}</td>
                                <td>${totalInterest5}</td>
                                <td>${initial_profit}</td>
                                <td>-</td>
                                <td>-</td>
                                <td>${refund.status}</td>
                                <td>${refund.manager}</td>
                                <td>
                                    <button onclick="redirectToEdit('${refund._id}')">แก้ไข</button>
                                    <button onclick="redirectToDelete('${refund._id}')">ลบ</button>
                                </td>
                                <td><button onclick="handleShare('${refund._id}', '${refund.id_card_number}', '${refund.fname}', '${refund.lname}', '${refund.manager}', '${refund.contract_number}', '${refund.bill_number}')">ส่วนแบ่ง</button></td>
                            `;

                            // เพิ่มแถวใหม่ลงในตาราง
                            table.appendChild(tr);
                        })
                        .catch(error => {
                            console.error('Error calculating interest and profit:', error);
                        });
                });
            }).catch(error => {
                console.error('Error fetching refunds:', error);
            });
        })
        .catch(error => {
            console.error('Error fetching loans:', error);
        });
});
